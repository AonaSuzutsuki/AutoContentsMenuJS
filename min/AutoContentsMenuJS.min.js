/*! 
    AutoMenu    Copyright (C) AonaSuzutsuki 2020.
    MIT License
*/

function Stack(){const t=[];this.push=(e=>(e=>t.push(e))(e)),this.pop=(()=>t.length<=0?null:t.pop()),this.each=(e=>t.forEach((t,n)=>e(t)))}function Queue(){const t=[],e=e=>t.push(e);this.enqueueRange=(t=>{for(let[n,s]of Object.entries(t))e(s)}),this.enqueue=(t=>e(t)),this.dequeue=(()=>t.length<=0?null:t.shift()),this.get=(()=>item=t.length<0?null:t[0])}function AutoMenu(){const t={H1:0,H2:1,H3:2,H4:3,H5:4,H6:5};let e=null,n=null,s="",i="";const o=(e,n,s,i)=>{const l=n.pop(),a=l[0];let u=l[1];const h=e.dequeue(),c=(t=>{let e="";return t.each(t=>{e+=t}),e})(s),p=$("<li>"),r=$(h).attr("id"),d=i?`${c}${u} ${$(h).text()}`:$(h).text();p.append(((t,e)=>{const n=$("<a>");return n.attr("href",t),n.text(e),n})(`#${r}`,d)),a.append(p),n.push([a,u+1]);const f=e.get();if(null!=f){const l=t[f.tagName],c=t[h.tagName];if(l>c){const t=$("<ol>");n.push([t,1]),a.append(t),s.push(`${u}.`),o(e,n,s,i)}else if(l===c)o(e,n,s,i);else{const t=c-l;for(let e=0;e<t;e++)n.pop(),s.pop();o(e,n,s,i)}}},l=s=>{let l=$(`${e}, h1, h2, h3, h4, h5, h6`);n&&(l=l.not(n)),(e=>{const n={};$("*").each((t,e)=>{const s=$(e).attr("id");void 0!==s&&(n[s]=s in n?n[s]+1:0)}),e.each((e,s)=>{if(s.tagName in t){const t=$(s),e=t.attr("id");if(void 0===e){const e=t.text();if(e in n){let s=n[e];t.attr("id",`${e}_${++s}`),n[e]=s}else t.attr("id",e),n[e]=0}else n[e]=e in n?n[e]+1:0}})})(l);const a=(e=>{const n=[];let s=[];return e.each((e,i)=>{i.tagName in t?s.push(i):(s=[],n[n.length]=[i,s])}),0==n.length&&(n[0]=[null,s]),n})(l),u=$(`<div class="${i}">`);let h=1;for(let[t,e]of Object.entries(a)){const t=e[0];if(null!=t){let e=$("<div>").text($(t).text());e.addClass("content-title"),e.addClass("title-"+String(h++)),u.append(e)}const n=$("<ol>"),i=new Stack;i.push([n,1]);const l=new Queue;l.enqueueRange(e[1]);const a=new Stack;a.push(""),o(l,i,a,s),u.append(n)}return u};this.drawContentsMenu=((t,e=!1)=>{const n=l(e);$(t).append((()=>$(`<h3 class="${s}">`).text("目次"))()),$(t).append(n)}),this.registerGroup=(t=>e=t),this.ignoreGroupClass=(t=>n=t),this.registerGroupClass=(t=>s=t),this.registerContainerClass=(t=>i=t)}
